버그 없는 웹서비스를 운영하는 것도 중요하지만 사용자가 쾌적하게 이용할 수 있는 웹사이트를 만드는 것도 중요하다. 웹사이트의 성능은 조직이 이루고자 하는 목표와 직결될 수 있기 때문이다. 따라서 웹사이트의 성능을 객관적으로 평가할 수 있는 핵심 웹 지표에 대해 알아본다. 

**성능의 중요성을 보여주는 통계자료**

실제로 웹 성능은 사용자 경험과 상관관계가 있다. 디지털 마케팅 에이전시 회사에서 밝힌 웹사이트 성능은 다음과 같은 요소에 영향을 준다.

> 1초 내로 로딩되는 사이트는 5초 내로 로딩되는 사이트보다 전자상거래 전환율이 2.5배 더 높다.
> 
> 0 ~ 5초의 범위에서, 1초 로딩이 늦어질수록 전환율은 4.42%씩 떨어진다. 즉, 5초 이상 느려지면 전환율은 20% 가까이 떨어진다.
> 
> 페이지 로드 시간이 0 ~ 2초 사이인 페이지에서 가장 높은 전환율을 달성할 수 있다.

구글에서 밝힌 웹사이트 성능 관련 통계는 다음과 같다.

> 전체 웹페이지를 표시하는 데 필요한 최적의 평균 리소스 요청 수는 50회 미만이다.
> 
> 평균적으로 웹 페이지 전체를 요청하는 데 15.3초가 걸린다.
> 
> 인간의 뇌와 신경계를 분석한 결과, 페이지 로드 시간이 1초에서 10초로 늘어날수록 모바일 사이트를 이탈할 확률이 123% 증가한다.


## 핵심 웹 지표란?

구글이 만든 핵심 웹 지표는 웹사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어다.

- LCP(Largest Contentful Paint)
- FID(First Input Delay)
- CLS(Cumulative Layout Shift)
- TTFB(Time To First Byte)
- FCP(First Contentful Paint)

## LCP(Largest Contentful Paint)

페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 이미지 또는 텍스트를 렌더링하는 게 걸리는 시간을 의미한다. 또한 LCP는 페이지 로딩에 따라 최대 콘텐츠가 계속해서 변화한다.

- LCP 대상 종류
    - `<img>`
    - `<svg>` 내부의 `<image>`
    - poster 속성을 사용하는 `<video>`
    - url()을 통해 불러온 배경 이미지가 있는 요소
    - 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소(`<p>`, `<div>` 포함)

### 측정 방법

2.5초 이내로 응답이 오면 좋은 상태, 4초 이내로 응답이 오면 보통, 그 이상은 나쁨이다.

### 개선 방안

1. 뷰포트 최대 영역에서 이미지가 아닌 텍스트 위주로 넣으면 된다.
2. `<img>`, video poster를 사용해 이미지를 최적화해서 불러오기: `<img>`, video poster는 브라우저 프리로드 스캐너에 의해서 먼저 발견되어 빠르게 요청되기 때문에 html이 파싱되기 전에 병렬적으로 리소스를 다운로드할 수 있다.
3. 기타 개선 사항
    1. 이미지 무손실 압축해서 용량 최소화하기
    2. largest content에 lazy loading 적용하지 않기
    3. fadein도 로딩 속도를 늦춤
    4. 클라이언트에서 빌드하지 않기
    5. 최대 콘텐츠풀 리소스 직접 호스팅(같은 도메인에서 직접 호스팅하기): 다른 도메인이면 네트워킹 커넥션부터 다시 해야하기 때문이다.

## FID(First Input Delay)

웹사이트의 반응속도를 측정하는 지표. 사용자가 페이지와 처음 상호작용할 때 해당 상호 작용에 대한 응답으로 브라우저가 실제 이벤트 핸들러 처리를 시작하기까지의 시간을 의미한다.

구글은 RAIL이라고 사용자 경험을 4가지로 크게 분류하는데 이중 FID는 Response에 초점을 맞춘 지표다. Response는 사용자의 입력에 대한 반응 속도를 50ms 미만으로 이벤트를 처리해야한다는 정의다. 즉 사용자가 상호작용을 했을 때 메인 스레드가 이 반응을 할 수 있을 때까지 50ms가 걸리면 된다.(참고로 FID는 핸들러의 실행 시간을 측정하지는 않는다.)

### 기준 점수

- 100ms 이내로 응답이 오면 좋은 점수, 300ms 이내면 보통, 그 이후는 나쁨이다.

### 개선 방안

1. 긴 작업 최소화(개발자 도구 insights에서 long task라고 알려준다.)
    - 긴 작업을 꼭 브라우저에서 처리해야 하는지 고민하기
    - 긴 작업을 여러 개로 분리하기
2. 자바스크립트 코드 최소화(커버리지를 통해 사이트에서 사용하지 않는 코드를 볼 수 있는데 lazy loading이나 코드 제거 등으로 급하지 않은 코드는 나중에 요청할 수 있다.)
3. 폴리필 최소화하기(폴리필이 필요한 환경인지 확인, 꼭 필요한 폴리필인지 확인)
4. 타사스크립트 지연(중요도가 떨어지면 defer 사용하기, 광고는 뷰포트 내부에 있는 것이 아니라면 intersection Observer로 나중에 요청)

## CLS(Cumulative Layout Shift)

뷰포트 내부의 콘텐츠의 예기치 않은 이동에 대한 지표이다. 영향분율과 거리분율을 곱해서 점수를 낸다.

- 영향분율: 레이아웃 이동이 발생한 요소의 전체 높이와 뷰포트 높이의 비율을 의미한다.
- 거리분율: 이동이 발생한 요소가 뷰포트 대비 얼마나 이동했는지 의미한다.

### 기준 점수

0.1 이하면 좋음, 0.25면 보통 그 외에는 개선이 필요하다.

### 개선 방안

1. useLayoutEffect, SSR, 클라이언트에서 미리 노출이 예상될 부분에 HTML로 자리를 잡아두는 것이 CLS에 도움이 된다.
2. 폰트 로딩 최적화
    
    FOUT(flash of unstyled text), FOIT(flash of invisible text)가 발생할 수 있다. 
    
    - <link>의 preload 사용. 중요한 리소스를 더 빠르게 사용할 수 있도록 준비
    - font-family: optional 사용하기. 폰트를 불러오는 옵션에는 5가지가 있다. (auto, block, swap, fallback, optional) 이중 fallback과 optional은 100ms 동안 폰트가 보이지 않다가 폴백 폰트로 먼저 렌더링하고 3초 안에 폰트가 로딩되지 않으면 폴백 폰트를 계속 사용하고 로딩이 된다면 지정한 폰트를 사용한다.
3. 적절한 이미지 크기 설정: img 태그에 width, height 속성에 비율에 맞는 값 넣어두기. srcset을 사용해 뷰포트 너비에 맞춰 다른 이미지를 제공하는 것도 방법이다.

## TTFB(Time To First Byte)

최초의 응답이 오는 바이트까지 걸리는 시간을 의미한다. 600ms이상 걸리면 개선이 필요하다고 간주한다. 서버 사이드 렌더링을 사용할 때 주의해야 한다.

- 로직을 최소화하기
- 국적과 가깝게 서버를 위치시키기
- 스트리밍 API를 사용해서 완성된 조각부터 차례대로 받기

## FCP(First Contentful Paint)

웹사이트에 접속한 순간부터 페이지에 뭐라도 뜨기 시작한 시간을 의미한다. 1.8초 이내로 이루어지면 좋음, 3초 이내는 보통 그 외에는 개선이 필요하다.,

- TTB를 개선한다.
- 렌더링을 가로막는 리소스 최소화(JS, CSS처럼 렌더링을 가로막는 리소스를 최소화히거나 비동기적으로 요청한다.)
- Above the Fold 최적화
- 리다이랙션 최소화
- DOM 크기 최소화.(1500미만, 깊이는 32단계 까지만, 부모는 자식 노드를 60개 정도만)
