메모리 관리 API

이 장에서 말하는 메모리란 사용자 주소 공간을 의미한다.

<aside>
💡

핵심 질문: 어떻게 메모리를 할당하고 관리해야 하는가

일반적으로 어떤 인터페이스가 사용되는가?

어떤 실수를 해서는 안 되는가?

</aside>

### 12.1 메모리 공간의 종류

C 프로그램이 실행되면, 두 가지 유형의 메모리 공간이 할당된다.

- 스택 메모리: 컴파일러에 의해 관리된다. 때로는 자동 메모리라 불린다.
  ```c
  void func() {
  	int x; // 스택에 int 형을 선언
  }
  ```
  `func`함수 호출 시 스택에 공간을 확보한다. 함수가 리턴되면 메모리를 반환한다.
  함수 리턴 이후에도 유지되어야 하는 정보는 스택에 저장하지 않는 것이 좋다.
- 힙 메모리: 모든 할당과 반환이 프로그래머에 의해 명시적으로 처리된다.
  ```c
  void func() {
  	int *x = (int *) malloc(sizeof(int));
  }
  // 정수에 대한 포인터를 힙에 할당하는 예
  ```
  한 행에서 스택과 힙 할당이 모두 발생한다.

### 12.2 malloc() 함수

`malloc(size)`는 크기만큼 힙 메모리를 할당하고 해당 메모리 주소값을 리턴한다.

`malloc`의 반환 타입은 void이다. 어떤 타입의 데이터를 저장할 지는 프로그래머에게 달려있다. 하지만 (double\*) 같이 타입 캐스팅을 통해 어떤 타입의 데이터가 올 것이라는 것을 미리 예측하게 하는 것이 좋다. 물론 이런 타입 캐스팅은 예측을 도울 뿐 실제로 double 타입이 아닌 다른 타입이 올 수도 있음을 주의하자.

### 12.3 free() 함수

힙 메모리 해제를 위해 사용.

```c
int *x = malloc(10 * sizeof(int));
...
free(x);
```

인자로 포인터를 넘긴다. 할당된 영역의 크기는 전달되지 않는다. 할당된 메모리의 크기는 메모리 할당 라이브러리가 알고 있어야 한다.

### 12.4 흔한 오류

많은 새로운 언어들이 자동 메모리 관리 (automatic memory management)를 지원한다. 그런 언어들은 메모리 할당을 위한 문법은 존재하지만 해제를 위한 문법은 존재하지 않는다. 내부에서 Garbage Collector가 실행되어 참조되지 않는 메모리를 알아서 해제하기 때문이다.

**12.4-1 메모리 할당 잊어버리기**

```c
char *src = "hello";
char *dst;
strcpy(dst, src); // segfault
```

dst에 메모리 할당을 안 해주어서 세그폴트 발생

**12.4-2 메모리를 부족하게 할당받기**

메모리를 부족하게 할당 받는 것, Buffet overflow라고 불린다.

이와 같은 오류는 가끔씩 제대로 동작하는 것처럼 보일 때가 있다.

```c
char *src = "hello";
char *dst = (char*) malloc(strlen(src));
strcpy(dst, src); //제대로 동작

// 하지만 문자열의 끝을 알려주는 문자 때문에 온전히 복사되지 않은 상태임
```

**12.4-3 할당받은 메모리 초기화하지 않기**

메모리 공간을 할당만 해두고 초기화하는 것을 잊지마라!

**12.4-4 메모리 해제하지 않기**

메모리 누수에 유의하라. Memory Leak.

메모리 청크의 사용이 끝나면 반드시 해제해야 한다. 사용하는 언어가 GC가 존재한다고 하더라도 해당 메모리에 대한 참조를 해제하지 않으면 GC도 소용이 없다.

**12.4-5 메모리 사용이 끝나기 전에 메모리 해제하기**

**12.4-6 반복적으로 메모리 해제하기**

### 12.5 운영체제의 지원

malloc()과 free()는 시스템 콜이 아니라 라이브러리 함수이다.

해당 라이브러리 내부에서 시스템 콜을 활용한 구현이 되어있다.

쓰이는 시스템 콜 중 하나가 brk라고 불리는 시스템 콜이다. 이는 시스템의 break 위치를 변경하는데 사용된다. break는 힙의 마지막 위치를 나타낸다.

brk(새로운 break 주소) → 새로운 break가 현재 break보다 큰지 작은지에 따라 힙의 크기를 증가시키거나 감소시킨다.

하지만 brk, sbrk를 직접 호출해서는 안된다.

### 12.6 기타 함수들

`calloc()` malloc과 같이 메모리 할당 추가로 0으로 초기화해준다.

`realloc()`이미 할당된 공간에 대해 추가 공간이 필요할 때 재할당.
