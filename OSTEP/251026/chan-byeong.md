<aside>
💡

핵심 질문: 어떻게 효율적이고 유연하게 메모리를 가상화하는가

어떻게 효율적인 메모리 가상화를 구축할 수 있을까?

프로그램이 필요로 하는 유연성을 어떻게 제공하는가?

프로그램이 접근할 수 있는 메모리의 위치에 대한 제어를 어떻게 유지하는가?

메모리 접근을 어떻게 적절히 제한할 수 있는가?

</aside>

하드웨어-기반 주소 변환 = 주소 변환.

주소 변환을 통해 하드웨어는 명령어 반입, 탑재, 저장 등의 가상 주소를 정보가 실제 존재하는 물리 주소로 변환한다. 프로그램의 모든 메모리 참조를 실제 메모리 위치로 재지정하기 위하여 **_하드웨어가 주소를 변환한다._**

하드웨어만으로는 메모리 가상화 구현 불가. 정확한 변환이 일어날 수 있도록 *운영체제의 관여*가 필요하다. 운영체제는 메모리의 빈 공간과 사용 중인 공간을 항상 추적하고, 메모리 사용을 제어하고 관리한다.

이 모든 작업의 목표: **_프로그램이 자신의 전용 메모리를 소유하고 그 안에 자신의 코드와 데이터가 있다는 환상을 만드는 것_**

## 1. 가정

사용자 주소 공간은 물리 메모리에 연속적으로 배치되어야 한다고 가정한다.

주소 공간은 물리 메모리 크기보다 작다. 각 주소 공간의 크기는 같다고 가정한다.

## 2. 사례

## 3. 동적(하드웨어-기반) 재배치

1950년대 후반 첫번째 시분할 컴퓨터에서 베이스와 바운드라는 간단한 아이디어가 채택되었다.

이 기술을 동적 재배치라고 한다.

각 CPU마다 2개의 하드웨어 레지스터가 존재. (베이스와 바운드)

이 베이스와 바운드 쌍은 우리가 원하는 위치에 주소 공간을 배치할 수 있게 한다. 배치와 동시에 프로세스가 오직 자신의 주소 공간에만 접근하다는 것을 보장한다. ( 해당 설정 덕분에 각 프로그램은 주소 0에 탑재되는 것처럼 작성되고 컴파일된다.)

운영체제가 **_프로그램이 탑재될 물리 메모리 위치_**를 결정하고 **\*베이스 레지스터를 그 주소로 결정**.\*

![image.png](attachment:3e2e1e5a-62f7-493d-89ab-57eb24b38220:image.png)

프로세스에서 생성되는 모든 주소는

**_physical address = virtual address + base_**

위와 같이 변환된다.

바운드는 언제 쓰이는가? 안전장치이다.

프로세스가 참조하는 주소가 바운드 안에 있는지 확인한다. 즉 위의 그림에서는 바운드 레지스터의 크기는 16KB로 고정된다.

주소 변환에 도움을 주는 프로세서의 일부를 **_메모리 관리 장치(Memory Management Unit) MMU라 부른다._**

## 4. 하드웨어 지원: 요약

먼저 CPU 가상화 장에서 설명했듯이 두 가지 CPU 모드가 필요하다.

커널모드에서 실행하며 컴퓨터 전체에 대한 접근 권한을 가진다.

응용 프로그램은 사용자 모드에서 실행되며, 할 수 있는 일이 제한된다.

Processor status word 레지스터의 한 비트가 CPU의 모드를 나타낸다. 특정 순간( 시스템 콜 또는 다른 종류의 예외나 인터럽트 발생 시) CPU는 모드를 전환한다.

실행되는 프로세스가 변경될 때 마다 커널모드에서 베이스와 바운드 레지스터를 변경한다.

## 5. 운영체제 이슈

베이스-바운드 방식의 가상 메모리 구현을 위해 운영체제가 반드시 개입되어야 하는 중요한 시점 세개 존재.

1. 프로세스가 생성될 때 운영체제는 주소 공간이 저장될 메모리 공간을 찾아 조치를 취해야 한다.

   빈 공간 리스트 자료구조를 검색한다.

2. 프로세스가 종료될 때 사용하던 메모리를 회수해야 한다.
3. 문맥 교환이 일어날 떄 몇 가지 추가 조치를 취해야 한다. 프로세스 전환 시 베이스와 바운드 쌍을 저장 및 복원해야 한다. 운영체제는 메모리에 존재하는 프로세스 별 자료 구조 안에 베이스와 바운으 레지스터의 값을 저장해야 한다.

   이 자료 구조는 프로세스 구조체 또는 프로세스 제어 블록(PCB)라고 불린다.

## 6. 동적 재배치를 안 쓰는 이유

단편화가 발생하여 메모리 공간의 낭비가 발생한다. 이를 내부 단편화라고 한다. (동적으로 할당한 내부 공간이 모두 쓰이지 않음) _(할당되었지만 사용되지 않는)_

![image.png](attachment:3e2e1e5a-62f7-493d-89ab-57eb24b38220:image.png)

일반화된 베이스-바운드 기법을 세그멘테이션이라고 부른다.
